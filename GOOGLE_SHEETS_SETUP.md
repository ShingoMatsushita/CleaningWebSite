# Googleスプレッドシート連携セットアップ手順

このドキュメントでは、CTAセクションのフォーム送信をGoogleスプレッドシートに保存するための設定手順を説明します。

## 前提条件

- Googleアカウントを持っていること
- 既存のGoogleスプレッドシートへのアクセス権限があること

## 設定情報

- **スプレッドシートID**: `1QpoD5M2Bz2W5d-3FIfyAnYJ82etGjllNQelSA3ngI7w`
- **スプレッドシートURL**: https://docs.google.com/spreadsheets/d/1QpoD5M2Bz2W5d-3FIfyAnYJ82etGjllNQelSA3ngI7w/edit
- **シート名**: `シート1`

## ステップ1: Googleスプレッドシートの準備

1. 上記のスプレッドシートURLを開きます
2. シート「シート1」が存在することを確認します（存在しない場合は作成）
3. 1行目に以下のヘッダーを設定します（既に設定されている場合はスキップ）:
   - A1: `名前`
   - B1: `メール`
   - C1: `電話`
   - D1: `サービス`
   - E1: `メッセージ`
   - F1: `言語`
   - G1: `タイムスタンプ`
   - H1: `IPアドレス`

## ステップ2: Google Apps Scriptの設定

1. スプレッドシートで **拡張機能** > **Apps Script** をクリックします
2. 新しいタブでApps Scriptエディタが開きます
3. 既存のコードをすべて削除します
4. `google-apps-script.js` ファイルの内容をコピーして、エディタに貼り付けます
5. コード内の設定を確認します:
   ```javascript
   const SPREADSHEET_ID = '1QpoD5M2Bz2W5d-3FIfyAnYJ82etGjllNQelSA3ngI7w';
   const SHEET_NAME = 'シート1';
   ```
6. ファイルを保存します（Ctrl+S / Cmd+S）

## ステップ3: Webアプリとしてデプロイ

1. Apps Scriptエディタで **デプロイ** > **新しいデプロイ** をクリックします
2. デプロイの種類の横にある歯車アイコン（⚙️）をクリックします
3. **種類を選択** で **ウェブアプリ** を選択します
4. 以下の設定を行います:
   - **説明**: 「フォーム送信用Webアプリ」（任意）
   - **次のユーザーとして実行**: **自分**
   - **アクセスできるユーザー**: **全員**
5. **デプロイ** ボタンをクリックします
6. 初回デプロイ時は承認が必要です:
   - **アクセスを承認** をクリック
   - Googleアカウントを選択
   - 「このアプリは確認されていません」という警告が表示された場合:
     - **詳細** をクリック
     - **（プロジェクト名）に移動（安全ではないページ）** をクリック
   - 権限を確認して **許可** をクリック
7. デプロイが完了すると、**WebアプリのURL** が表示されます
8. このURLをコピーします（例: `https://script.google.com/macros/s/AKfycby.../exec`）

## ステップ4: フロントエンドの設定

1. `script.js` ファイルを開きます
2. 以下の設定を更新します:
   ```javascript
   const GOOGLE_SHEETS_CONFIG = {
       webAppUrl: 'YOUR_WEB_APP_URL'  // ここにコピーしたURLを貼り付け
   };
   ```
3. `YOUR_WEB_APP_URL` をステップ3でコピーしたURLに置き換えます
4. ファイルを保存します

## ステップ5: 動作確認

1. ウェブサイトのCTAセクションでフォームを送信します
2. Googleスプレッドシートを開いて、データが正しく保存されているか確認します
3. 以下の項目が記録されていることを確認します:
   - 名前
   - メール
   - 電話（入力された場合）
   - サービス
   - メッセージ（入力された場合）
   - 言語（ja/zh/en）
   - タイムスタンプ（自動記録）
   - IPアドレス（自動記録）

## トラブルシューティング

### データが保存されない場合

1. **WebアプリURLの確認**
   - `script.js` の `webAppUrl` が正しく設定されているか確認
   - URLの末尾が `/exec` になっているか確認

2. **Apps Scriptのログ確認**
   - Apps Scriptエディタで **実行** > **ログを表示** を確認
   - エラーメッセージがないか確認

3. **スプレッドシートの権限確認**
   - スプレッドシートへの書き込み権限があるか確認
   - Apps Scriptの実行ユーザーが正しく設定されているか確認

4. **CORSエラーの場合**
   - ブラウザのコンソール（F12）でエラーを確認
   - Webアプリのアクセス権限が「全員」になっているか確認

### タイムスタンプが正しく表示されない場合

- Apps Scriptのタイムゾーン設定を確認
- コード内のタイムゾーンが `Asia/Tokyo` になっているか確認

### IPアドレスが「Unknown」と表示される場合

- これは正常な動作です（Google Apps ScriptではIPアドレスの取得が制限される場合があります）
- 必要に応じて、フロントエンドからIPアドレスを取得して送信する方法に変更可能です

## セキュリティに関する注意事項

- Webアプリのアクセス権限は「全員」に設定されていますが、これはフォーム送信に必要です
- スプレッドシート自体の共有設定は適切に管理してください
- 必要に応じて、認証トークンを追加してセキュリティを強化できます

## 追加のカスタマイズ

### メール通知を追加する場合

Google Apps Scriptに以下のコードを追加することで、データ保存時にメール通知を送信できます:

```javascript
// doPost関数内、データ保存後に追加
MailApp.sendEmail({
  to: 'your-email@example.com',
  subject: '新しいお問い合わせ: ' + postData.name,
  body: '名前: ' + postData.name + '\n' +
        'メール: ' + postData.email + '\n' +
        '電話: ' + postData.phone + '\n' +
        'サービス: ' + postData.service + '\n' +
        'メッセージ: ' + postData.message
});
```

### データの自動バックアップ

Apps Scriptのトリガー機能を使用して、定期的にデータをバックアップできます。

## サポート

問題が解決しない場合は、以下を確認してください:
- Google Apps Scriptの公式ドキュメント: https://developers.google.com/apps-script
- スプレッドシートのヘッダー行が正しく設定されているか
- ブラウザのコンソールにエラーが表示されていないか

